<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Post - SafeVoice</title>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <link rel="stylesheet" href="./style.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <script src="https://unpkg.com/feather-icons"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <custom-navbar></custom-navbar>

    <main class="max-w-4xl mx-auto px-4 py-8">
        <div class="bg-white rounded-2xl shadow-lg p-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Create Anonymous Post</h1>
            <p class="text-gray-600 mb-8">Share your thoughts, experiences, or support others in complete privacy</p>

            <!-- RESTORED: Privacy Tier Selector -->
            <div class="mb-8">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Select Privacy Level</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- Standard Tier -->
                    <div class="border-2 border-blue-200 rounded-xl p-4 cursor-pointer hover:border-blue-400 transition-colors">
                        <div class="flex items-center gap-2 mb-2">
                            <input type="radio" name="privacyTier" value="standard" checked class="text-blue-600 focus:ring-blue-500">
                            <label class="font-medium text-gray-800">Standard</label>
                        </div>
                        <p class="text-sm text-gray-600 mb-2">Basic anonymity with encrypted storage</p>
                        <div class="text-blue-600 font-semibold">Free</div>
                    </div>
                    <!-- PGP Tier -->
                    <div class="border-2 border-green-200 rounded-xl p-4 cursor-pointer hover:border-green-400 transition-colors">
                        <div class="flex items-center gap-2 mb-2">
                            <input type="radio" name="privacyTier" value="pgp" class="text-green-600 focus:ring-green-500">
                            <label class="font-medium text-gray-800">PGP Encrypted</label>
                        </div>
                        <p class="text-sm text-gray-600 mb-2">Client-side encryption</p>
                        <div class="text-green-600 font-semibold">5 Tokens</div>
                    </div>
                    <!-- Tor Tier -->
                    <div class="border-2 border-purple-200 rounded-xl p-4 cursor-pointer hover:border-purple-400 transition-colors">
                        <div class="flex items-center gap-2 mb-2">
                            <input type="radio" name="privacyTier" value="tor" class="text-purple-600 focus:ring-purple-500">
                            <label class="font-medium text-gray-800">Tor Routed</label>
                        </div>
                        <p class="text-sm text-gray-600 mb-2">Maximum privacy routing</p>
                        <div class="text-purple-600 font-semibold">10 Tokens</div>
                    </div>
                </div>
            </div>

            <!-- Post Form -->
            <form id="createPostForm" class="space-y-6">
                <!-- Content Type -->
                <!-- ... existing content type buttons ... -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Post Type</label>
                    <div class="flex gap-4">
                        <button type="button" id="btn-type-text" class="post-type-btn bg-blue-600 text-white px-6 py-3 rounded-lg font-medium flex items-center gap-2" data-type="text">
                            <i data-feather="file-text" class="w-4 h-4"></i> Text
                        </button>
                        <button type="button" id="btn-type-image" class="post-type-btn bg-white text-gray-700 border px-6 py-3 rounded-lg font-medium transition-all duration-300 flex items-center gap-2" data-type="image">
                            <i data-feather="image" class="w-4 h-4"></i> Image
                        </button>
                        <button type="button" id="btn-type-voice" class="post-type-btn bg-white text-gray-700 border px-6 py-3 rounded-lg font-medium transition-all duration-300 flex items-center gap-2" data-type="voice">
                            <i data-feather="mic" class="w-4 h-4"></i> Voice
                        </button>
                    </div>
                </div>


                <!-- Dynamic Content Sections -->
                <!-- ... existing text, image, voice sections ... -->
                 <!-- Text Input (Default) -->
                <div id="content-text" class="content-section space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Your Message</label>
                        <textarea
                            id="postContent"
                            placeholder="Share your thoughts, experiences, or offer support to others... (Markdown supported)"
                            class="w-full h-48 p-4 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        ></textarea>
                    </div>
                </div>

                <!-- Image Input (Hidden) -->
                <div id="content-image" class="content-section space-y-6 hidden">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Upload Image</label>
                        <input type="file" id="imageUpload" accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                        <div id="imagePreview" class="mt-4 hidden max-w-sm h-auto rounded-lg shadow-md overflow-hidden">
                            <img src="" alt="Image Preview" class="w-full h-auto object-cover">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Image Caption (Optional)</label>
                        <textarea
                            id="imageCaption"
                            placeholder="Add a caption for your image..."
                            class="w-full h-24 p-4 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        ></textarea>
                    </div>
                </div>

                <!-- Voice Input (Hidden) -->
                <div id="content-voice" class="content-section space-y-6 hidden">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Record or Upload Voice Note</label>
                        <div class="p-6 border-2 border-dashed border-gray-300 rounded-xl text-center">
                            <i data-feather="mic" class="w-12 h-12 text-gray-400 mx-auto"></i>
                            <p class="mt-4 text-gray-600">Voice recording and upload functionality is coming soon!</p>
                            <!-- Placeholder for future Tone.js or MediaRecorder integration -->
                        </div>
                    </div>
                </div>


                <!-- Topic Selection -->
                <!-- ... existing topic select ... -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Select Topic</label>
                    <select id="topicSelect" class="w-full p-4 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">Choose a topic...</option>
                        <option value="mental-health">Mental Health & Wellness</option>
                        <option value="academics">Academics & Studies</option>
                        <option value="relationships">Relationships & Friendships</option>
                        <option value="social-issues">Social Justice & Issues</option>
                        <option value="memorials">Memorials & Tributes</option>
                        <option value="career">Career & Future</option>
                        <option value="crisis">Crisis Support</option>
                        <option value="other">Other (Please specify)</option>
                    </select>
                </div>


                <!-- "Other" Topic Input -->
                <!-- ... existing other topic input ... -->
                <div id="otherTopicWrapper" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Your Custom Topic</label>
                    <input
                        type="text"
                        id="otherTopicInput"
                        placeholder="Type your custom topic..."
                        class="w-full p-4 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    >
                </div>

                <!-- College Tagging -->
                <!-- ... existing college input ... -->
                 <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">College/University (Optional)</label>
                    <input
                        type="text"
                        id="collegeTag"
                        placeholder="e.g., Stanford University, Community College..."
                        class="w-full p-4 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    >
                </div>


                <!-- Submit Section -->
                <div class="border-t pt-6">
                    <!-- ... existing submit buttons ... -->
                    <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600">Expected Reward: <span class="font-semibold text-green-600">+10 tokens</span></p>
                            </div>
                            <div class="flex gap-4">
                                <button type="button" id="saveDraftBtn" class="bg-gray-500 hover:bg-gray-600 text-white px-8 py-4 rounded-xl font-semibold transition-all duration-300">Save Draft</button>
                                <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-4 rounded-xl font-semibold transition-all duration-300">Post Anonymously</button>
                            </div>
                        </div>
                </div>
            </form>
        </div>

        <!-- Toast Notifications -->
        <!-- ... existing toast elements ... -->
        <div id="draft-toast" class="hidden fixed bottom-10 right-10 bg-gray-800 text-white p-4 rounded-lg shadow-lg">
            Draft saved!
        </div>
        <div id="load-draft-toast" class="hidden fixed bottom-10 left-1/2 -translate-x-1/2 bg-gray-800 text-white p-4 rounded-lg shadow-lg flex items-center gap-4">
            <p>We found a saved draft. Restore it?</p>
            <button id="restoreDraftBtn" class="bg-blue-500 px-3 py-1 rounded">Yes</button>
            <button id="discardDraftBtn" class="bg-gray-600 px-3 py-1 rounded">No</button>
        </div>

    </main>

    <custom-footer></custom-footer>

    <script src="./navbar.js"></script>
    <script src="./footer.js"></script>
    <script src="./script.js"></script>
    <script>
        feather.replace(); // Initial replace

        document.addEventListener('DOMContentLoaded', () => {
            // Re-run feather after dynamic elements might load
            setTimeout(() => feather.replace(), 100);

            // --- 1. Content Type Toggle Logic ---
            const typeButtons = document.querySelectorAll('.post-type-btn');
            const contentSections = document.querySelectorAll('.content-section');
            let activePostType = 'text'; // Default

            typeButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    activePostType = this.dataset.type; // Update active type

                    // Update button styles
                    typeButtons.forEach(b => {
                        b.classList.remove('bg-blue-600', 'text-white');
                        b.classList.add('bg-white', 'text-gray-700', 'border');
                    });
                    this.classList.add('bg-blue-600', 'text-white');
                    this.classList.remove('bg-white', 'text-gray-700', 'border');

                    // Show/hide content sections
                    contentSections.forEach(section => {
                        if (section.id === `content-${activePostType}`) {
                            section.classList.remove('hidden');
                        } else {
                            section.classList.add('hidden');
                        }
                    });
                    feather.replace(); // Ensure icons render correctly
                });
            });

            // --- 2. Image Preview Logic ---
             const imageUpload = document.getElementById('imageUpload');
             const imagePreviewDiv = document.getElementById('imagePreview');
             const imagePreviewImg = imagePreviewDiv.querySelector('img');

             if(imageUpload && imagePreviewDiv && imagePreviewImg) { // Check elements exist
                imageUpload.addEventListener('change', (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            imagePreviewImg.src = e.target.result;
                            imagePreviewDiv.classList.remove('hidden');
                        };
                        reader.readAsDataURL(file);
                    } else {
                        imagePreviewDiv.classList.add('hidden');
                        imagePreviewImg.src = '';
                    }
                });
            } else {
                console.error("Image upload/preview elements not found!");
            }

            // --- 3. "Other" Topic Logic ---
             const topicSelect = document.getElementById('topicSelect');
             const otherTopicWrapper = document.getElementById('otherTopicWrapper');
             const otherTopicInput = document.getElementById('otherTopicInput'); // Added

             if (topicSelect && otherTopicWrapper) { // Check elements exist
                topicSelect.addEventListener('change', () => {
                    if (topicSelect.value === 'other') {
                        otherTopicWrapper.classList.remove('hidden');
                    } else {
                        otherTopicWrapper.classList.add('hidden');
                        otherTopicInput.value = ''; // Clear custom topic if switching away
                    }
                });
            } else {
                 console.error("Topic select elements not found!");
            }

            // --- 4. "Save Draft" Logic ---
             const saveDraftBtn = document.getElementById('saveDraftBtn');
             const draftToast = document.getElementById('draft-toast');
             const postContent = document.getElementById('postContent');
             const imageCaption = document.getElementById('imageCaption');
             const collegeTag = document.getElementById('collegeTag');
             const privacyTiers = document.querySelectorAll('input[name="privacyTier"]'); // Added

            if (saveDraftBtn && draftToast) { // Check elements exist
                saveDraftBtn.addEventListener('click', () => {
                    let selectedPrivacy = 'standard';
                    privacyTiers.forEach(radio => {
                        if (radio.checked) {
                            selectedPrivacy = radio.value;
                        }
                    });

                    const draft = {
                        type: activePostType,
                        content: postContent.value,
                        imageCaption: imageCaption.value,
                        topic: topicSelect.value,
                        otherTopic: otherTopicInput.value,
                        college: collegeTag.value,
                        privacy: selectedPrivacy
                        // Image file is not saved, only caption and type
                    };

                    localStorage.setItem('safeVoiceDraft', JSON.stringify(draft));

                    draftToast.classList.remove('hidden');
                    setTimeout(() => {
                        draftToast.classList.add('hidden');
                    }, 2000);
                });
            } else {
                 console.error("Save draft elements not found!");
            }

            // --- 5. "Load Draft" Logic ---
             const loadDraftToast = document.getElementById('load-draft-toast');
             const restoreDraftBtn = document.getElementById('restoreDraftBtn');
             const discardDraftBtn = document.getElementById('discardDraftBtn');
             const savedDraft = localStorage.getItem('safeVoiceDraft');

            if (savedDraft && loadDraftToast && restoreDraftBtn && discardDraftBtn) { // Check elements exist
                loadDraftToast.classList.remove('hidden');

                restoreDraftBtn.addEventListener('click', () => {
                    const draft = JSON.parse(savedDraft);

                    // Restore type button and section visibility
                    const typeBtnToClick = document.querySelector(`.post-type-btn[data-type="${draft.type}"]`);
                    if(typeBtnToClick) typeBtnToClick.click();

                    // Restore content
                    postContent.value = draft.content || '';
                    imageCaption.value = draft.imageCaption || '';
                    topicSelect.value = draft.topic || '';
                    otherTopicInput.value = draft.otherTopic || '';
                    collegeTag.value = draft.college || '';

                     // Restore privacy tier
                    privacyTiers.forEach(radio => {
                        if (radio.value === draft.privacy) {
                            radio.checked = true;
                        }
                    });

                    // Trigger "Other" input visibility if needed
                    if (draft.topic === 'other') {
                        otherTopicWrapper.classList.remove('hidden');
                    } else {
                        otherTopicWrapper.classList.add('hidden');
                    }

                    // Note: Cannot restore image file selection

                    localStorage.removeItem('safeVoiceDraft');
                    loadDraftToast.classList.add('hidden');
                });

                discardDraftBtn.addEventListener('click', () => {
                    localStorage.removeItem('safeVoiceDraft');
                    loadDraftToast.classList.add('hidden');
                });
            }


            // --- 6. Form Submission (Simulation) ---
             const createPostForm = document.getElementById('createPostForm');
             if(createPostForm) { // Check form exists
                createPostForm.addEventListener('submit', async function(e) {
                    e.preventDefault();

                    // Determine content based on active type
                    let contentValue = '';
                    if (activePostType === 'text') {
                        contentValue = postContent.value.trim();
                    } else if (activePostType === 'image') {
                        contentValue = imageCaption.value.trim();
                         if (!imageUpload.files[0] && !contentValue) { // Allow image OR caption, but need one
                           alert('Please upload an image or add a caption.');
                           return;
                         }
                    } else if (activePostType === 'voice') {
                        alert('Voice posting is not yet implemented.');
                        return;
                    }

                    let topic = topicSelect.value;
                    if (topic === 'other') {
                        topic = otherTopicInput.value.trim();
                        if(!topic) {
                            alert('Please enter your custom topic.');
                            return;
                        }
                    }
                    if (!topic) {
                        alert('Please select a topic.');
                        return;
                    }

                    // No need to validate contentValue being empty if image is present
                    if (activePostType === 'text' && !contentValue) {
                       alert('Please enter your message.');
                       return;
                    }

                    let selectedPrivacy = 'standard';
                    privacyTiers.forEach(radio => {
                        if (radio.checked) {
                            selectedPrivacy = radio.value;
                        }
                    });


                    const submitBtn = this.querySelector('button[type="submit"]');
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<i data-feather="loader" class="inline w-4 h-4 mr-2 animate-spin"></i> Posting...';
                    feather.replace();

                    try {
                        await new Promise(resolve => setTimeout(resolve, 1500));

                        if (window.safeVoiceApp) {
                            window.safeVoiceApp.awardTokens(10, 'post_created');
                            alert('ðŸŽ‰ Post created successfully! +10 tokens awarded.');
                        } else {
                            alert('ðŸŽ‰ Post created successfully! (Tokens simulated)');
                        }


                        localStorage.removeItem('safeVoiceDraft');
                        this.reset();
                        otherTopicWrapper.classList.add('hidden');
                        if(imagePreviewDiv) imagePreviewDiv.classList.add('hidden');
                        if(imageUpload) imageUpload.value = '';
                        document.getElementById('btn-type-text').click(); // Reset to text type

                         // Reset privacy tier to standard
                        privacyTiers.forEach(radio => radio.checked = (radio.value === 'standard'));


                        window.location.href = './feed.html';
                    } catch (error) {
                        console.error('Post creation failed:', error);
                        alert('Failed to create post. Please try again.');
                    } finally {
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Post Anonymously';
                    }
                });
            } else {
                 console.error("Create post form not found!");
            }

        }); // End DOMContentLoaded
    </script>
</body>
</html>

