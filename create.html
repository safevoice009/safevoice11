<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Post - SafeVoice</title>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <link rel="stylesheet" href="./style.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <script src="https://unpkg.com/feather-icons"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <custom-navbar></custom-navbar>

    <main class="max-w-4xl mx-auto px-4 py-8">
        <div class="bg-white rounded-2xl shadow-lg p-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Create Anonymous Post</h1>
            <p class="text-gray-600 mb-8">Share your thoughts, experiences, or support others in complete privacy</p>

            {/* <!-- RESTORED: Privacy Tier Selector --> */}
            <div class="mb-8">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Select Privacy Level</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    {/* <!-- Standard Tier --> */}
                    <div class="border-2 border-blue-200 rounded-xl p-4 cursor-pointer hover:border-blue-400 transition-colors has-[:checked]:border-blue-500 has-[:checked]:ring-2 has-[:checked]:ring-blue-200">
                        <label class="flex flex-col h-full"> {/* Make label cover the div */}
                            <div class="flex items-center gap-2 mb-2">
                                <input type="radio" name="privacyTier" value="standard" checked class="text-blue-600 focus:ring-blue-500">
                                <span class="font-medium text-gray-800">Standard</span>
                            </div>
                            <p class="text-sm text-gray-600 mb-2 flex-grow">Basic anonymity with encrypted storage</p> {/* Use flex-grow */}
                            <div class="text-blue-600 font-semibold mt-auto">Free</div> {/* Use mt-auto */}
                        </label>
                    </div>
                    {/* <!-- PGP Tier --> */}
                     <div class="border-2 border-green-200 rounded-xl p-4 cursor-pointer hover:border-green-400 transition-colors has-[:checked]:border-green-500 has-[:checked]:ring-2 has-[:checked]:ring-green-200">
                         <label class="flex flex-col h-full">
                            <div class="flex items-center gap-2 mb-2">
                                <input type="radio" name="privacyTier" value="pgp" class="text-green-600 focus:ring-green-500">
                                <span class="font-medium text-gray-800">PGP Encrypted</span>
                            </div>
                            <p class="text-sm text-gray-600 mb-2 flex-grow">Client-side encryption for added security</p>
                            <div class="text-green-600 font-semibold mt-auto">5 Tokens</div>
                        </label>
                    </div>
                    {/* <!-- Tor Tier --> */}
                     <div class="border-2 border-purple-200 rounded-xl p-4 cursor-pointer hover:border-purple-400 transition-colors has-[:checked]:border-purple-500 has-[:checked]:ring-2 has-[:checked]:ring-purple-200">
                         <label class="flex flex-col h-full">
                            <div class="flex items-center gap-2 mb-2">
                                <input type="radio" name="privacyTier" value="tor" class="text-purple-600 focus:ring-purple-500">
                                <span class="font-medium text-gray-800">Tor Routed</span>
                            </div>
                            <p class="text-sm text-gray-600 mb-2 flex-grow">Maximum privacy via Tor network routing</p>
                            <div class="text-purple-600 font-semibold mt-auto">10 Tokens</div>
                        </label>
                    </div>
                </div>
            </div>

            {/* <!-- Post Form --> */}
            <form id="createPostForm" class="space-y-6">
                {/* <!-- Content Type --> */}
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Post Type</label>
                    <div class="flex gap-4">
                        <button type="button" id="btn-type-text" class="post-type-btn bg-blue-600 text-white px-6 py-3 rounded-xl font-medium flex items-center gap-2" data-type="text"> {/* Rounded-xl */}
                            <i data-feather="file-text" class="w-5 h-5"></i> Text
                        </button>
                        <button type="button" id="btn-type-image" class="post-type-btn bg-white text-gray-700 border px-6 py-3 rounded-xl font-medium transition-all duration-300 flex items-center gap-2" data-type="image">
                            <i data-feather="image" class="w-5 h-5"></i> Image
                        </button>
                        <button type="button" id="btn-type-voice" class="post-type-btn bg-white text-gray-700 border px-6 py-3 rounded-xl font-medium transition-all duration-300 flex items-center gap-2" data-type="voice">
                            <i data-feather="mic" class="w-5 h-5"></i> Voice
                        </button>
                    </div>
                </div>


                {/* <!-- Dynamic Content Sections --> */}
                {/* <!-- Text Input --> */}
                <div id="content-text" class="content-section space-y-6">
                     <div>
                        <label for="postContent" class="block text-sm font-medium text-gray-700 mb-2">Your Message</label> {/* Added for */}
                        <textarea
                            id="postContent"
                            placeholder="Share your thoughts, experiences, or offer support to others... (Markdown supported)"
                            class="w-full h-48 p-4 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        ></textarea>
                    </div>
                </div>

                {/* <!-- Image Input --> */}
                <div id="content-image" class="content-section space-y-6 hidden">
                     <div>
                        <label for="imageUpload" class="block text-sm font-medium text-gray-700 mb-2">Upload Image</label>
                        <input type="file" id="imageUpload" accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer">
                         <p class="text-xs text-gray-500 mt-1">Max file size: 5MB.</p>
                        <div id="imagePreviewWrapper" class="mt-4 hidden"> {/* Wrapper for potential remove button */}
                             <div id="imagePreview" class="relative max-w-sm h-auto rounded-lg shadow-md overflow-hidden border border-gray-200">
                                <img src="" alt="Image Preview" class="w-full h-auto object-cover">
                                 <button type="button" id="removeImageBtn" class="absolute top-2 right-2 bg-red-600 text-white rounded-full p-1 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2">
                                     <i data-feather="x" class="w-4 h-4"></i>
                                 </button>
                            </div>
                        </div>
                    </div>
                    <div>
                        <label for="imageCaption" class="block text-sm font-medium text-gray-700 mb-2">Image Caption (Optional)</label>
                        <textarea
                            id="imageCaption"
                            placeholder="Add a caption for your image..."
                            class="w-full h-24 p-4 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        ></textarea>
                    </div>
                </div>

                {/* <!-- Voice Input --> */}
                <div id="content-voice" class="content-section space-y-6 hidden">
                     <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Record or Upload Voice Note</label>
                        <div class="p-6 border-2 border-dashed border-gray-300 rounded-xl text-center bg-gray-50">
                            <i data-feather="mic" class="w-12 h-12 text-gray-400 mx-auto"></i>
                            <p class="mt-4 text-gray-600">Voice recording and upload functionality is coming soon!</p>
                            {/* Placeholder for future buttons: Record, Stop, Play, Upload */}
                             <div class="mt-4 space-x-2">
                                 <button type="button" disabled class="bg-gray-300 text-gray-500 px-4 py-2 rounded-lg text-sm cursor-not-allowed">Record</button>
                                 <button type="button" disabled class="bg-gray-300 text-gray-500 px-4 py-2 rounded-lg text-sm cursor-not-allowed">Upload File</button>
                             </div>
                        </div>
                    </div>
                </div>


                {/* <!-- Topic Selection --> */}
                 <div>
                    <label for="topicSelect" class="block text-sm font-medium text-gray-700 mb-2">Select Topic</label>
                    <select id="topicSelect" class="w-full p-4 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white">
                        <option value="">Choose a topic...</option>
                        <option value="mental-health">Mental Health & Wellness</option>
                        <option value="academics">Academics & Studies</option>
                        <option value="relationships">Relationships & Friendships</option>
                        <option value="social-issues">Social Justice & Issues</option>
                        <option value="memorials">Memorials & Tributes</option>
                        <option value="career">Career & Future</option>
                        <option value="crisis">Crisis Support</option>
                        <option value="other">Other (Please specify)</option>
                    </select>
                </div>


                {/* <!-- "Other" Topic Input --> */}
                <div id="otherTopicWrapper" class="hidden">
                    <label for="otherTopicInput" class="block text-sm font-medium text-gray-700 mb-2">Your Custom Topic</label>
                    <input
                        type="text"
                        id="otherTopicInput"
                        placeholder="Type your custom topic..."
                        class="w-full p-4 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    >
                </div>

                {/* <!-- College Tagging --> */}
                 <div>
                    <label for="collegeTag" class="block text-sm font-medium text-gray-700 mb-2">College/University (Optional)</label>
                    <input
                        type="text"
                        id="collegeTag"
                        placeholder="e.g., Stanford University, Community College..."
                        class="w-full p-4 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    >
                </div>


                {/* <!-- Submit Section --> */}
                <div class="border-t pt-6">
                    <div class="flex flex-col sm:flex-row items-center justify-between gap-4"> {/* Added gap and flex-col */}
                        <div>
                            <p class="text-sm text-gray-600">Expected Reward: <span class="font-semibold text-green-600">+10 tokens</span></p>
                        </div>
                        <div class="flex gap-4">
                            <button type="button" id="saveDraftBtn" class="bg-gray-500 hover:bg-gray-600 text-white px-8 py-3 rounded-xl font-semibold transition-all duration-300 text-sm sm:text-base">Save Draft</button> {/* Adjusted padding/size */}
                            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-xl font-semibold transition-all duration-300 text-sm sm:text-base">Post Anonymously</button>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        {/* <!-- Toast Notifications --> */}
         <div id="draft-toast" class="hidden fixed bottom-10 right-10 bg-gray-900 text-white p-4 rounded-lg shadow-lg z-[2100]"> {/* Increased z-index */}
            Draft saved!
        </div>
        <div id="load-draft-toast" class="hidden fixed bottom-10 left-1/2 -translate-x-1/2 bg-gray-900 text-white p-4 rounded-lg shadow-lg flex items-center gap-4 z-[2100]">
            <p>We found a saved draft. Restore it?</p>
            <button id="restoreDraftBtn" class="bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded text-sm">Yes</button>
            <button id="discardDraftBtn" class="bg-gray-600 hover:bg-gray-700 px-3 py-1 rounded text-sm">No</button>
        </div>

    </main>

    <custom-footer></custom-footer>

    <script src="./navbar.js"></script>
    <script src="./footer.js"></script>
    <script src="./script.js"></script>
    <script>
        feather.replace(); // Initial replace

        document.addEventListener('DOMContentLoaded', () => {
             // Re-run feather after dynamic elements might load & for remove button
            setTimeout(() => feather.replace(), 100);

            // --- 1. Content Type Toggle Logic ---
            // ... (keep existing toggle logic) ...
            const typeButtons = document.querySelectorAll('.post-type-btn');
            const contentSections = document.querySelectorAll('.content-section');
            let activePostType = 'text'; // Default

            typeButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    activePostType = this.dataset.type; // Update active type

                    // Update button styles
                    typeButtons.forEach(b => {
                        b.classList.remove('bg-blue-600', 'text-white');
                        b.classList.add('bg-white', 'text-gray-700', 'border');
                    });
                    this.classList.add('bg-blue-600', 'text-white');
                    this.classList.remove('bg-white', 'text-gray-700', 'border');

                    // Show/hide content sections
                    contentSections.forEach(section => {
                        if (section.id === `content-${activePostType}`) {
                            section.classList.remove('hidden');
                        } else {
                            section.classList.add('hidden');
                        }
                    });
                    feather.replace(); // Ensure icons render correctly
                });
            });

            // --- 2. Image Preview & Remove Logic ---
             const imageUpload = document.getElementById('imageUpload');
             const imagePreviewWrapper = document.getElementById('imagePreviewWrapper');
             const imagePreviewDiv = document.getElementById('imagePreview');
             const imagePreviewImg = imagePreviewDiv?.querySelector('img'); // Use optional chaining
             const removeImageBtn = document.getElementById('removeImageBtn');

             if(imageUpload && imagePreviewWrapper && imagePreviewImg && removeImageBtn) {
                imageUpload.addEventListener('change', (event) => {
                    const file = event.target.files[0];
                    if (file) {
                         if (file.size > 5 * 1024 * 1024) { // 5MB limit
                            alert("Image file is too large! Maximum 5MB allowed.");
                            imageUpload.value = ""; // Clear the input
                            imagePreviewWrapper.classList.add('hidden'); // Hide preview
                            imagePreviewImg.src = '';
                            return;
                        }
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            imagePreviewImg.src = e.target.result;
                            imagePreviewWrapper.classList.remove('hidden'); // Show wrapper
                            feather.replace(); // Render the 'x' icon
                        };
                        reader.readAsDataURL(file);
                    } else { // No file selected (e.g., user clicked cancel)
                        imagePreviewWrapper.classList.add('hidden');
                        imagePreviewImg.src = '';
                    }
                });

                removeImageBtn.addEventListener('click', () => {
                     imageUpload.value = ''; // Clear the file input
                     imagePreviewWrapper.classList.add('hidden'); // Hide the preview wrapper
                     imagePreviewImg.src = ''; // Clear the image source
                });

            } else {
                console.error("Image upload/preview/remove elements not found!");
            }

            // --- 3. "Other" Topic Logic ---
            // ... (keep existing "Other" topic logic) ...
            const topicSelect = document.getElementById('topicSelect');
            const otherTopicWrapper = document.getElementById('otherTopicWrapper');
            const otherTopicInput = document.getElementById('otherTopicInput');

            if (topicSelect && otherTopicWrapper && otherTopicInput) { // Check elements exist
                topicSelect.addEventListener('change', () => {
                    if (topicSelect.value === 'other') {
                        otherTopicWrapper.classList.remove('hidden');
                    } else {
                        otherTopicWrapper.classList.add('hidden');
                        otherTopicInput.value = ''; // Clear custom topic
                    }
                });
            } else {
                 console.error("Topic select elements not found!");
            }


            // --- 4. "Save Draft" Logic ---
            // ... (keep existing save draft logic, ensures privacy tier is saved) ...
            const saveDraftBtn = document.getElementById('saveDraftBtn');
            const draftToast = document.getElementById('draft-toast');
            const postContent = document.getElementById('postContent');
            const imageCaption = document.getElementById('imageCaption');
            const collegeTag = document.getElementById('collegeTag');
            const privacyTiers = document.querySelectorAll('input[name="privacyTier"]');

            if (saveDraftBtn && draftToast) {
                saveDraftBtn.addEventListener('click', () => {
                    let selectedPrivacy = 'standard';
                    privacyTiers.forEach(radio => {
                        if (radio.checked) {
                            selectedPrivacy = radio.value;
                        }
                    });

                    const draft = {
                        type: activePostType,
                        content: postContent.value,
                        imageCaption: imageCaption.value,
                        topic: topicSelect.value,
                        otherTopic: otherTopicInput.value,
                        college: collegeTag.value,
                        privacy: selectedPrivacy
                    };

                    localStorage.setItem('safeVoiceDraft', JSON.stringify(draft));

                    draftToast.classList.remove('hidden');
                    setTimeout(() => {
                        draftToast.classList.add('hidden');
                    }, 2000);
                });
            } else {
                 console.error("Save draft elements not found!");
            }


            // --- 5. "Load Draft" Logic ---
            // ... (keep existing load draft logic, ensures privacy tier is restored) ...
            const loadDraftToast = document.getElementById('load-draft-toast');
            const restoreDraftBtn = document.getElementById('restoreDraftBtn');
            const discardDraftBtn = document.getElementById('discardDraftBtn');
            const savedDraft = localStorage.getItem('safeVoiceDraft');

            if (savedDraft && loadDraftToast && restoreDraftBtn && discardDraftBtn) {
                loadDraftToast.classList.remove('hidden');

                restoreDraftBtn.addEventListener('click', () => {
                    const draft = JSON.parse(savedDraft);

                    // Restore type button and section visibility
                    const typeBtnToClick = document.querySelector(`.post-type-btn[data-type="${draft.type}"]`);
                    if(typeBtnToClick) typeBtnToClick.click();

                    // Restore content
                    postContent.value = draft.content || '';
                    imageCaption.value = draft.imageCaption || '';
                    topicSelect.value = draft.topic || '';
                    otherTopicInput.value = draft.otherTopic || '';
                    collegeTag.value = draft.college || '';

                     // Restore privacy tier
                    privacyTiers.forEach(radio => {
                        radio.checked = (radio.value === draft.privacy);
                    });

                    // Trigger "Other" input visibility if needed
                    if (draft.topic === 'other') {
                        otherTopicWrapper.classList.remove('hidden');
                    } else {
                        otherTopicWrapper.classList.add('hidden');
                    }

                    localStorage.removeItem('safeVoiceDraft');
                    loadDraftToast.classList.add('hidden');
                    alert('Draft restored!'); // Add feedback
                });

                discardDraftBtn.addEventListener('click', () => {
                    localStorage.removeItem('safeVoiceDraft');
                    loadDraftToast.classList.add('hidden');
                });
            }

            // --- 6. Form Submission (Simulation) ---
             const createPostForm = document.getElementById('createPostForm');
             if(createPostForm) {
                createPostForm.addEventListener('submit', async function(e) {
                     // ... (keep existing validation and submission logic) ...
                     e.preventDefault();

                    let contentValue = '';
                    let imageFile = null; // Store image file if present

                    if (activePostType === 'text') {
                        contentValue = postContent.value.trim();
                         if (!contentValue) {
                           alert('Please enter your message.');
                           return;
                         }
                    } else if (activePostType === 'image') {
                        contentValue = imageCaption.value.trim(); // Caption is optional
                        imageFile = imageUpload.files[0];
                         if (!imageFile && !contentValue) { // Must have at least image or caption
                           alert('Please upload an image or add a caption.');
                           return;
                         }
                    } else if (activePostType === 'voice') {
                        alert('Voice posting is not yet implemented.');
                        return;
                    }

                    let topic = topicSelect.value;
                    if (topic === 'other') {
                        topic = otherTopicInput.value.trim();
                        if(!topic) {
                            alert('Please enter your custom topic.');
                            return;
                        }
                    }
                    if (!topic) {
                        alert('Please select a topic.');
                        return;
                    }

                     let selectedPrivacy = 'standard';
                    privacyTiers.forEach(radio => {
                        if (radio.checked) {
                            selectedPrivacy = radio.value;
                        }
                    });

                    const submitBtn = this.querySelector('button[type="submit"]');
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<i data-feather="loader" class="inline w-4 h-4 mr-2 animate-spin"></i> Posting...';
                    feather.replace();

                    try {
                        // --- Placeholder for Supabase Upload ---
                        let imageUrl = null;
                        if (imageFile) {
                             console.log("Simulating image upload for:", imageFile.name);
                             // In real app: await uploadImageToSupabase(imageFile);
                             await new Promise(resolve => setTimeout(resolve, 1000)); // Simulate upload time
                             // imageUrl = 'https://path/to/uploaded/image.jpg'; // Get URL from Supabase
                             console.log("Image upload simulation complete.");
                        }
                        // ------------------------------------

                        console.log("Simulating post save...");
                        await new Promise(resolve => setTimeout(resolve, 500)); // Simulate DB save time
                        console.log("Post save simulation complete.");


                        if (window.safeVoiceApp) {
                            window.safeVoiceApp.awardTokens(10, 'post_created');
                            alert('ðŸŽ‰ Post created successfully! +10 tokens awarded.');
                        } else {
                            alert('ðŸŽ‰ Post created successfully! (Tokens simulated)');
                        }


                        localStorage.removeItem('safeVoiceDraft');
                        this.reset();
                        otherTopicWrapper.classList.add('hidden');
                        if(imagePreviewWrapper) imagePreviewWrapper.classList.add('hidden'); // Use wrapper
                        if(imageUpload) imageUpload.value = '';
                        document.getElementById('btn-type-text').click(); // Reset to text type
                        privacyTiers.forEach(radio => radio.checked = (radio.value === 'standard'));


                        window.location.href = './feed.html';
                    } catch (error) {
                        console.error('Post creation failed:', error);
                        alert('Failed to create post. Please try again.');
                    } finally {
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Post Anonymously';
                    }
                });
            } else {
                 console.error("Create post form not found!");
            }

        }); // End DOMContentLoaded
    </script>
</body>
</html>

