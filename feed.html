<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SafeVoice Feed - Anonymous Student Discussions</title>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <link rel="stylesheet" href="./style.css">
    {/* <!-- Supabase CDN MUST be included before script.js --> */}
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <script src="https://unpkg.com/feather-icons"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <custom-navbar></custom-navbar>

    <main class="max-w-6xl mx-auto px-4 py-8">
        {/* <!-- Feed Header --> */}
        <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-8 gap-4">
             <div>
                <h1 class="text-3xl font-bold text-gray-800">SafeVoice Feed</h1>
                <p class="text-gray-600">Real-time anonymous discussions from students worldwide</p>
            </div>

            <div class="flex flex-wrap gap-2" id="filter-buttons">
                {/* Filter buttons remain, logic will now fetch from Supabase */}
                <button data-filter="all" class="filter-btn bg-blue-600 text-white px-4 py-2 rounded-lg font-medium">All</button>
                <button data-filter="trending" class="filter-btn bg-white text-gray-700 px-4 py-2 rounded-lg font-medium border">Trending</button>
                <button data-filter="latest" class="filter-btn bg-white text-gray-700 px-4 py-2 rounded-lg font-medium border">Latest</button>
                <button data-filter="crisis" class="filter-btn bg-white text-gray-700 px-4 py-2 rounded-lg font-medium border">Crisis</button>
                <button data-filter="mental-health" class="filter-btn bg-white text-gray-700 px-4 py-2 rounded-lg font-medium border">Mental Health</button>
                <button data-filter="memorial" class="filter-btn bg-white text-gray-700 px-4 py-2 rounded-lg font-medium border">Memorials</button>
            </div>
        </div>

        {/* <!-- Search Bar --> */}
        <div class="mb-8 max-w-xl">
             <div class="relative">
                <input
                    type="text"
                    id="feedSearchInput"
                    placeholder="Search posts by keyword..."
                    class="w-full p-4 pl-12 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                >
                <i data-feather="search" class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 w-5 h-5"></i>
            </div>
        </div>

        {/* <!-- Main Feed Grid --> */}
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            {/* <!-- Posts Column --> */}
            <div class="lg:col-span-2 space-y-6" id="posts-container">
                {/* --- POSTS WILL BE RENDERED HERE DYNAMICALLY --- */}

                 {/* --- Loading State --- */}
                 <div id="loading-indicator" class="text-center py-10">
                     <div class="inline-block animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"></div>
                     <p class="mt-4 text-gray-600">Loading posts...</p>
                 </div>

                 {/* --- Empty State --- */}
                 <div id="empty-state" class="hidden text-center py-10 bg-white rounded-2xl shadow p-6">
                     <i data-feather="message-square" class="w-16 h-16 text-gray-400 mx-auto mb-4"></i>
                     <h3 class="text-xl font-semibold text-gray-800 mb-2">No Posts Yet</h3>
                     <p class="text-gray-600 mb-4">Be the first to share your voice or check back later!</p>
                     <a href="./create.html" class="inline-flex items-center justify-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-xl font-medium transition-all duration-300 text-center text-sm">
                         <i data-feather="edit-3" class="w-5 h-5"></i>
                         <span>Create a Post</span>
                     </a>
                 </div>

                 {/* --- Error State --- */}
                 <div id="error-state" class="hidden text-center py-10 bg-red-50 rounded-2xl shadow p-6 border border-red-200">
                     <i data-feather="alert-triangle" class="w-16 h-16 text-red-500 mx-auto mb-4"></i>
                     <h3 class="text-xl font-semibold text-red-800 mb-2">Error Loading Posts</h3>
                     <p class="text-red-700 mb-4">Could not fetch posts from the server. Please try refreshing the page.</p>
                     <button onclick="location.reload()" class="inline-flex items-center justify-center gap-2 bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-xl font-medium transition-all duration-300 text-center text-sm">
                         <i data-feather="refresh-cw" class="w-5 h-5"></i>
                         <span>Refresh Page</span>
                     </button>
                 </div>

            </div> {/* <!-- End Posts Column --> */}

            {/* <!-- Sidebar --> */}
            <div class="space-y-6 lg:sticky lg:top-24 h-fit">
                {/* Sidebar content remains the same, token balance updated via script.js event */}
                 {/* <!-- Token Balance Card --> */}
                <div class="bg-gradient-to-br from-yellow-400 to-orange-500 text-white rounded-2xl shadow-lg p-6">
                    <div class="flex items-center gap-2 mb-2">
                        <i data-feather="award" class="w-5 h-5"></i>
                        <h3 class="text-lg font-semibold">Your Token Balance</h3>
                    </div>
                    <div class="text-4xl font-bold token-pulse mb-1" id="tokenBalanceDisplay">0</div>
                    <p class="text-yellow-100 text-sm">Earn tokens for supporting others and creating helpful content</p>
                </div>

                {/* <!-- Quick Actions --> */}
                <div class="bg-white rounded-2xl shadow-lg p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Quick Actions</h3>
                    <div class="space-y-3">
                        <a href="./create.html" class="flex items-center justify-center gap-2 w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-3 rounded-xl font-medium transition-all duration-300 text-center text-sm">
                            <i data-feather="edit-3" class="w-5 h-5"></i>
                            <span>Create New Post</span>
                        </a>
                        <a href="./memorials.html" class="flex items-center justify-center gap-2 w-full border border-purple-600 text-purple-600 hover:bg-purple-600 hover:text-white px-4 py-3 rounded-xl font-medium transition-all duration-300 text-center text-sm">
                            <i data-feather="heart" class="w-5 h-5"></i>
                            <span>Visit Memorials</span>
                        </a>
                    </div>
                </div>

                {/* <!-- Trending Topics --> */}
                <div class="bg-white rounded-2xl shadow-lg p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Trending Topics</h3>
                    <div class="space-y-2">
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 cursor-pointer transition-colors duration-200">
                            <span class="font-medium text-sm text-gray-700">#MentalHealthAwareness</span>
                            <span class="text-blue-600 text-xs font-semibold bg-blue-100 px-2 py-0.5 rounded-full">342</span>
                        </div>
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 cursor-pointer transition-colors duration-200">
                            <span class="font-medium text-sm text-gray-700">#ExamStress</span>
                            <span class="text-blue-600 text-xs font-semibold bg-blue-100 px-2 py-0.5 rounded-full">287</span>
                        </div>
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 cursor-pointer transition-colors duration-200">
                            <span class="font-medium text-sm text-gray-700">#StudentLife</span>
                            <span class="text-blue-600 text-xs font-semibold bg-blue-100 px-2 py-0.5 rounded-full">215</span>
                        </div>
                         <a href="#" class="block text-sm text-blue-600 hover:underline text-center mt-2">View all topics</a>
                    </div>
                </div>
            </div> {/* <!-- End Sidebar --> */}
        </div> {/* <!-- End Grid --> */}
    </main>

    {/* <!-- Image Modal --> */}
    <div id="imageModal" class="image-modal">
        <button id="imageModalClose" class="image-modal-close">
            <i data-feather="x"></i>
        </button>
        <div class="image-modal-content">
            <img id="modalImage" src="" alt="Full-screen post image">
        </div>
    </div>

    <custom-footer></custom-footer>

    <script src="./navbar.js"></script>
    <script src="./footer.js"></script>
    <script src="./script.js"></script> {/* Supabase client is initialized here */}
    <script>
        // Use feather directly as modules aren't used here
        // feather.replace(); // Initial replacement done in script.js now

        document.addEventListener('DOMContentLoaded', async () => {
             // Ensure feather icons are rendered initially and after dynamic content
            const renderIcons = () => {
                 if (typeof feather !== 'undefined') {
                     feather.replace();
                 } else {
                     console.warn("Feather not ready for replacement.");
                 }
            };
            renderIcons(); // Initial render
            // setTimeout(renderIcons, 100); // Render again shortly after load

            const postsContainer = document.getElementById('posts-container');
            const loadingIndicator = document.getElementById('loading-indicator');
            const emptyState = document.getElementById('empty-state');
            const errorState = document.getElementById('error-state');
            const filterButtons = document.querySelectorAll('#filter-buttons .filter-btn');
            const searchInput = document.getElementById('feedSearchInput');

            let currentFilter = 'all'; // Keep track of the active filter
            let currentSearchQuery = ''; // Keep track of search

            // --- Function to Render a Single Post ---
            function renderPost(post) {
                // Basic check for essential data
                 if (!post || !post.id || !post.created_at || !post.content) {
                    console.warn("Skipping invalid post object:", post);
                    return ''; // Return empty string if post data is invalid
                }

                const timeAgo = SafeVoiceUtils.formatDate(post.created_at);
                const escapedContent = SafeVoiceUtils.escapeHTML(post.content);
                const escapedCollege = SafeVoiceUtils.escapeHTML(post.college || 'Unknown College');
                const escapedTopic = SafeVoiceUtils.escapeHTML(post.topic || 'General');
                // Use anonymous ID if available, otherwise a placeholder
                const anonymousId = SafeVoiceUtils.escapeHTML(post.anonymous_id || 'AnonUser' + String(post.id).slice(-4));
                const postTopic = post.topic || 'other'; // Default topic if null
                const contentForSearch = escapedContent.toLowerCase(); // For data attribute

                 // Simple topic-to-tag mapping
                 const topicTags = {
                    'mental-health': '<span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full font-medium">Mental Health</span>',
                    'academics': '<span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full font-medium">Academics</span>',
                    'relationships': '<span class="px-2 py-1 bg-pink-100 text-pink-800 text-xs rounded-full font-medium">Relationships</span>',
                    'social-issues': '<span class="px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded-full font-medium">Social Issues</span>',
                    'memorials': '<span class="px-2 py-1 bg-purple-100 text-purple-800 text-xs rounded-full font-medium">Memorial</span>',
                    'career': '<span class="px-2 py-1 bg-indigo-100 text-indigo-800 text-xs rounded-full font-medium">Career</span>',
                    'crisis': '<span class="px-2 py-1 bg-red-100 text-red-800 text-xs rounded-full font-medium">Crisis</span>',
                    'other': '<span class="px-2 py-1 bg-gray-100 text-gray-800 text-xs rounded-full font-medium">Other</span>'
                 };
                 const topicTagHtml = topicTags[postTopic] || topicTags['other']; // Fallback tag


                return `
                <div class="post-card bg-white rounded-2xl shadow-lg p-6 fade-in" data-topic="${postTopic}" data-content="${contentForSearch}">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-10 h-10 bg-gradient-to-br from-gray-400 to-gray-600 rounded-full flex items-center justify-center text-white">
                            <i data-feather="user" class="w-5 h-5"></i>
                        </div>
                        <div>
                            <div class="text-sm font-semibold text-gray-800">${anonymousId}</div>
                            <div class="text-xs text-gray-500">${timeAgo} â€¢ ${escapedCollege}</div>
                        </div>
                    </div>

                    <div class="flex items-center gap-2 mb-3">
                        ${topicTagHtml}
                    </div>

                    <p class="text-gray-700 mb-4 leading-relaxed">${escapedContent}</p>

                    ${post.image_url ? `
                    <div class="my-4 rounded-lg overflow-hidden border border-gray-200">
                        <img src="${SafeVoiceUtils.escapeHTML(post.image_url)}" alt="Post Image" class="w-full h-auto max-h-[400px] object-cover cursor-pointer post-image" loading="lazy" onerror="this.style.display='none'">
                    </div>` : ''}

                    <div class="flex items-center gap-4 pt-4 mt-4 border-t border-gray-100">
                        <button class="reaction-btn flex items-center gap-1 text-gray-500 hover:text-red-500 transition-colors" data-post-id="${post.id}" data-reaction="support">
                            <i data-feather="heart" class="w-5 h-5"></i>
                            <span class="reaction-count text-sm font-medium">${post.reaction_support || 0}</span>
                        </button>
                        <button class="reaction-btn flex items-center gap-1 text-gray-500 hover:text-orange-500 transition-colors" data-post-id="${post.id}" data-reaction="strong">
                            <i data-feather="zap" class="w-5 h-5"></i>
                            <span class="reaction-count text-sm font-medium">${post.reaction_strong || 0}</span> {/* Assuming you add this column */}
                        </button>
                        <button class="reaction-btn flex items-center gap-1 text-gray-500 hover:text-blue-500 transition-colors" data-post-id="${post.id}" data-reaction="healing">
                            <i data-feather="feather" class="w-5 h-5"></i>
                            <span class="reaction-count text-sm font-medium">${post.reaction_healing || 0}</span> {/* Assuming you add this column */}
                        </button>
                        <a href="./post.html?id=${post.id}" class="flex items-center gap-1 text-sm text-gray-500 hover:text-purple-600 transition-colors ml-auto">
                            <i data-feather="message-circle" class="w-5 h-5"></i>
                            <span class="font-medium">${post.comment_count || 0}</span> {/* Assuming you add this column/join */}
                        </a>
                        <button class="flex items-center gap-1 text-sm text-gray-500 hover:text-green-600 transition-colors">
                            <i data-feather="share-2" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>`;
            }

            // --- Function to Fetch and Render Posts ---
            async function fetchAndRenderPosts(filter = 'all', query = '') {
                if (!postsContainer || !loadingIndicator || !emptyState || !errorState) {
                    console.error("Required elements for rendering posts are missing.");
                    return;
                }
                if (!supabase) {
                    console.error("Supabase client not initialized.");
                     loadingIndicator.classList.add('hidden');
                     errorState.classList.remove('hidden');
                    return;
                }

                // Show loading state, hide others
                loadingIndicator.classList.remove('hidden');
                postsContainer.innerHTML = ''; // Clear previous posts (keep loading indicator separate)
                emptyState.classList.add('hidden');
                errorState.classList.add('hidden');

                try {
                    console.log(`Fetching posts with filter: ${filter}, query: ${query}`);
                    let queryBuilder = supabase
                        .from('posts')
                        .select('*') // Select specific columns later for optimization
                        .order('created_at', { ascending: false })
                        .limit(50); // Add a limit

                    // Apply topic filter if not 'all'
                    if (filter !== 'all') {
                         // Map UI filter names to potential DB topic values
                         const filterMap = {
                             'mental-health': 'mental-health', // Assuming DB value is the same
                             'crisis': 'crisis',
                             'memorial': 'memorials', // Example: UI 'memorial', DB 'memorials'
                             // Add other mappings as needed
                         };
                         const dbFilter = filterMap[filter] || filter; // Use mapped value or original
                        queryBuilder = queryBuilder.eq('topic', dbFilter);
                    }

                    // Apply search query (text search on 'content' column)
                    if (query) {
                        // Use '.ilike()' for case-insensitive partial matching
                        queryBuilder = queryBuilder.ilike('content', `%${query}%`);
                    }

                    const { data: posts, error } = await queryBuilder;

                    if (error) {
                        throw error; // Throw error to be caught below
                    }

                    console.log("Posts fetched:", posts);

                    loadingIndicator.classList.add('hidden'); // Hide loading

                    if (posts && posts.length > 0) {
                        postsContainer.innerHTML = posts.map(renderPost).join('');
                        renderIcons(); // Render icons for the newly added posts
                    } else {
                        emptyState.classList.remove('hidden'); // Show empty state
                        renderIcons(); // Render empty state icon
                    }

                } catch (error) {
                    console.error('Error fetching posts:', error);
                    loadingIndicator.classList.add('hidden');
                    errorState.classList.remove('hidden'); // Show error state
                    renderIcons(); // Render error state icon
                }
            }

            // --- Event Listeners for Filters and Search ---
             function setActiveFilterButton(activeButton) {
                filterButtons.forEach(btn => {
                    btn.classList.remove('bg-blue-600', 'text-white');
                    btn.classList.add('bg-white', 'text-gray-700', 'border');
                });
                if (activeButton) {
                    activeButton.classList.add('bg-blue-600', 'text-white');
                    activeButton.classList.remove('bg-white', 'text-gray-700', 'border');
                }
            }

            filterButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const filter = button.dataset.filter;
                    if (filter === 'trending' || filter === 'latest') {
                         alert('Trending and Latest filters are coming soon!');
                         return; // Don't fetch yet
                    }
                    currentFilter = filter;
                    currentSearchQuery = ''; // Clear search when filter changes
                    if(searchInput) searchInput.value = '';
                    setActiveFilterButton(button);
                    fetchAndRenderPosts(currentFilter, currentSearchQuery);
                });
            });

            if (searchInput) {
                searchInput.addEventListener('input', SafeVoiceUtils.debounce(async (e) => {
                    currentSearchQuery = e.target.value.toLowerCase().trim();
                    currentFilter = 'all'; // Reset filter to 'all' when searching
                    // Visually reset filter button to 'All'
                    const allButton = document.querySelector('#filter-buttons .filter-btn[data-filter="all"]');
                    if (allButton) setActiveFilterButton(allButton);
                    await fetchAndRenderPosts(currentFilter, currentSearchQuery);
                }, 400)); // Increased debounce time slightly
            }

            // --- Initial Load ---
             // Set 'All' button as active visually on load
            const initialAllButton = document.querySelector('#filter-buttons .filter-btn[data-filter="all"]');
            if (initialAllButton) setActiveFilterButton(initialAllButton);
            // Fetch posts on initial load
            fetchAndRenderPosts(currentFilter, currentSearchQuery);


             // --- Update Token Display --- (Moved to global script.js listener)


             // --- Image Modal Logic --- (Moved to global script.js listener)


        }); // End DOMContentLoaded
    </script>
</body>
</html>

